"use strict";angular.module("foodTruckApp",["ngAnimate","ngResource","ngRoute","ngSanitize","ngTouch","nemLogging","ui-leaflet"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl as main"}).otherwise({redirectTo:"/"})}]),angular.module("foodTruckApp").controller("MainCtrl",["$scope","$timeout","HttpNotifications","FoodTrucks",function(a,b,c,d){function e(){l&&b.cancel(l);var a=m.center.lat,c=m.center.lng;d.fetch(a,c).then(g,h,i),m.focusId=0}function f(a){l&&b.cancel(l),d.fetch(!1,!1,a).then(g,h,i)}function g(a){angular.extend(m,{serverError:!1,trucks:a.data.trucks,address:a.data.address,truckMarkers:d.getMarkers(a.data.trucks)}),m.center.lat=parseFloat(a.data.lat),m.center.lng=parseFloat(a.data.lng),c.clearAll()}function h(a){if(-1===a.status&&1===a.config.timeout.$$state.status)return!1;switch(a.status){case-1:c.set(-1,"Internet Connection Unavailable. Retrying Momentarily...");var d=a.config.params;l=b(function(){d.address?f(d.address):e()},8e3);break;case 422:c.set(422,"Bad search query. Please try another location.");break;case 500:c.set(500,"We Are Experiencing Temporary Server Issues.")}}function i(a){a.status||c.set(-1,"This seems to be taking a while...")}function j(a){m.focusId=parseInt(a)}function k(a){angular.forEach(m.truckMarkers,function(b,c){parseInt(c)===a?b.icon.markerColor="blue":b.icon.markerColor="black"})}var l,m=this;angular.extend(m,{center:{lat:37.7833,lng:-122.4167,zoom:16},leafletEvents:{map:{enable:["moveend"],logic:"emit"},markers:{}},focusId:0,fetchByAddress:f,httpNotifications:c}),a.$on("leafletDirectiveMap.moveend",e),a.$on("leafletDirectiveMarker.click",function(a,b){j(b.modelName)}),a.$watch(function(){return m.focusId},function(a,b){a&&a!==b&&k(a)}),e()}]),angular.module("foodTruckApp").factory("FoodTrucks",["$http","$q","$timeout",function(a,b,c){var d;return this.fetch=function(e,f,g){var h,i;if(e&&f)h={lat:e,lng:f};else{if(!g)return!1;h={address:g}}return d&&d.resolve(),d=b.defer(),c(function(){i.notify({})},5e3),i=b.defer(),a({method:"GET",url:"api/trucks/search",timeout:d.promise,params:h}).then(function(a){i.resolve(a)},function(a){i.reject(a)}),i.promise},this.getMarkers=function(a){var b={};return a?(a.forEach(function(a){if(!a.lat||!a.lng)return!1;var c={lat:parseFloat(a.lat),lng:parseFloat(a.lng),draggable:!1,focus:!0,title:a.name,label:{message:a.name,options:{noHide:!0}},icon:{icon:"cutlery",type:"awesomeMarker",markerColor:"black",iconColor:"white"}};b[a.id]=c}),b):b},this}]),angular.module("foodTruckApp").directive("ftTrucksList",function(){return{scope:{ftTrucks:"=",ftFocusId:"="},bindToController:!0,restrict:"E",controller:function(){},controllerAs:"trucksList",templateUrl:"views/directives/trucks-list.html"}}),angular.module("foodTruckApp").directive("ftCenterMarker",function(){return{templateUrl:"views/directives/center-marker.html",restrict:"E"}}),angular.module("foodTruckApp").service("HttpNotifications",function(){return this.all={},this.get=function(a){return this.all[a]},this.set=function(a,b){this.all[a]={message:b}},this.clear=function(a){delete this.all[a]},this.clearAll=function(){this.all={}},this});